services:
  borgmatic:
    image: ghcr.io/borgmatic-collective/borgmatic:latest
    container_name: borgmatic
    restart: unless-stopped

    volumes:
      - /opt/docker:/mnt/source:ro  # ğŸ” Maps your entire stack (read-only) as the backup source
      - ${DOCKER_DATA_DIR}/borgmatic:/etc/borgmatic  # âš™ï¸ Config folder containing config.yaml and optional .env
      - ${DOCKER_DATA_DIR}/borgmatic/.ssh:/root/.ssh  # ğŸ” SSH keys for connecting to BorgBase repo
      - ${DOCKER_DATA_DIR}/borgmatic/repo:/mnt/borg-repository  # ğŸ’¾ Optional local Borg repo (not used in your case)
      - ${DOCKER_DATA_DIR}/borgmatic/borg:/root/.config/borg  # ğŸ§  Key + cache metadata for Borg
      - ${DOCKER_DATA_DIR}/borgmatic/cache:/root/.cache/borg  # âš¡ Deduplication metadata
      - ${DOCKER_DATA_DIR}/borgmatic/logs:/var/log/borgmatic  # ğŸ“ Optional log folder (can be reviewed manually)

    environment:
      - TZ=${TZ}  # ğŸŒ Timezone (from global .env)
      - PUID=${PUID}  # ğŸ‘¤ User ID (from global .env)
      - PGID=${PGID}  # ğŸ‘¥ Group ID (from global .env)
      - BORG_PASSPHRASE=${BORG_PASSPHRASE}  # ğŸ” Encryption passphrase for backup
      - BORG_REPO_URL=${BORG_REPO_URL}  # ğŸ“¦ SSH repo path from BorgBase
      - BACKUP_CRON=0 4 * * 0  # ğŸ•“ Run backup every Sunday at 4 AM
      - RUN_ON_STARTUP=true   # ğŸš€ Also run once on container start

    profiles:
      - borgmatic  # ğŸ“‚ So you can include/exclude via Docker Compose profiles
      - all        # âœ… Include in full stack profile
